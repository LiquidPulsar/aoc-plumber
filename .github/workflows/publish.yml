name: Upload Python Package to PyPI when a Release is Created

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  pypi-publish:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:latest  # uv + CPython preinstalled
    steps:
      - uses: actions/checkout@v4

      # 3.10 is the minimum supported version for this project
      - name: Ensure Python 3.10 is installed
        run: uv python install 3.10

      - name: Check version match
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          PYPROJECT_VERSION=$(uv run --python 3.10 python -c \
            "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")

          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "Tag version does not match"
            exit 1
          fi

      - name: Build
        run: uv build --python 3.10

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
